<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hot Works Permit</title>

<link rel="manifest" href="manifest.json">

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f4f4f4;
  margin:0;
  padding:10px
}
h1,h2{margin:10px 0}
.section{
  background:#fff;
  padding:15px;
  margin-bottom:15px;
  border-radius:10px
}
label{
  display:block;
  margin-top:10px;
  font-weight:600
}
input,textarea,select{
  width:100%;
  padding:10px;
  margin-top:5px;
  font-size:16px
}
textarea{min-height:120px}
canvas{
  width:100%;
  height:160px;
  border:1px solid #ccc;
  touch-action:none
}
.locked{
  pointer-events:none;
  opacity:.6
}
button{
  margin-top:10px;
  padding:12px;
  font-size:16px;
  width:100%
}
.photo-preview img{
  max-width:100%;
  margin-top:10px;
  border-radius:8px
}
@media print{
  button{display:none}
}
</style>
</head>

<body>

<h1>Hot Works Permit</h1>
<p style="font-size:14px">
Designed to align with AS 1674.1, AS 1940 and applicable Australian WHS Regulations
</p>

<div class="section">
<label>Date</label>
<input type="date" id="date">

<label>Site / Location</label>
<input id="site">

<label>Company / Contractor</label>
<input id="company">
</div>

<div class="section">
<h2>Type of Hot Work</h2>

<select id="hotType">
  <option value="">Select</option>
  <option>Welding</option>
  <option>Cutting</option>
  <option>Grinding</option>
  <option>Oxy / LPG Heating</option>
  <option>Brazing / Soldering</option>
  <option>Torch-on / Heat Gun</option>
  <option>Other</option>
</select>

<label>If Other, describe</label>
<textarea id="hotOther"></textarea>
</div>

<div class="section">
<h2>Description of Works</h2>
<textarea id="description"></textarea>
</div>

<div class="section">
<h2>PPE Required</h2>
<textarea id="ppe"></textarea>
</div>

<div class="section">
<h2>Fire Watch</h2>

<label>Fire Watcher Name</label>
<input id="fireName">

<p>Fire watch to remain for a minimum of 30 minutes after completion.</p>

<label>Fire Watch Signature</label>
<canvas id="fireSig"></canvas>
<button onclick="clearSig('fireSig')">Undo Signature</button>

<label>Time Signed</label>
<input type="time" id="fireTime">
</div>

<div class="section">
<h2>Permit Authorisation</h2>

<label>Authorised By</label>
<input id="authName">

<label>Authorising Signature</label>
<canvas id="authSig"></canvas>
<button onclick="clearSig('authSig')">Undo Signature</button>

<label>Time Signed</label>
<input type="time" id="authTime">
</div>

<div class="section">
<h2>Photos</h2>

<label>Firefighting Equipment in Place (extinguishers, hose, fire blanket)</label>
<input type="file" accept="image/*" capture="environment" id="photoFire">
<div class="photo-preview" id="firePreview"></div>

<label>Before Hot Works</label>
<input type="file" accept="image/*" capture="environment" id="photoBefore">
<div class="photo-preview" id="beforePreview"></div>

<label>After Completion</label>
<input type="file" accept="image/*" capture="environment" id="photoAfter">
<div class="photo-preview" id="afterPreview"></div>
</div>

<div class="section">
<button onclick="exportPDF()">Export Permit (PDF)</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let permitFinalised=false;

const fields=document.querySelectorAll("input,textarea,select");

fields.forEach(f=>f.oninput=saveData);

function saveData(){
  const d={};
  fields.forEach(f=>d[f.id]=f.value);
  localStorage.setItem("permitData",JSON.stringify(d));
}

(function load(){
  const d=JSON.parse(localStorage.getItem("permitData")||"{}");
  fields.forEach(f=>{if(d[f.id])f.value=d[f.id]});
})();

function setupSig(id){
  const c=document.getElementById(id);
  const x=c.getContext("2d");
  let d=false;

  c.ontouchstart=e=>{
    if(permitFinalised)return;
    d=true;
    x.beginPath();
    x.moveTo(e.touches[0].clientX-c.offsetLeft,e.touches[0].clientY-c.offsetTop);
  };
  c.ontouchmove=e=>{
    if(!d||permitFinalised)return;
    x.lineTo(e.touches[0].clientX-c.offsetLeft,e.touches[0].clientY-c.offsetTop);
    x.stroke();
  };
  c.ontouchend=()=>d=false;
}

setupSig("fireSig");
setupSig("authSig");

function clearSig(id){
  if(permitFinalised)return;
  const c=document.getElementById(id);
  c.getContext("2d").clearRect(0,0,c.width,c.height);
}

fireTime.onchange=lockCheck;
authTime.onchange=lockCheck;

function lockCheck(){
  if(fireTime.value && authTime.value){
    permitFinalised=true;
    fields.forEach(f=>f.disabled=true);
    document.querySelectorAll("canvas").forEach(c=>c.classList.add("locked"));
  }
}

function preview(input,box){
  const img=document.createElement("img");
  img.src=URL.createObjectURL(input.files[0]);
  box.innerHTML="";
  box.appendChild(img);
}

photoFire.onchange=()=>preview(photoFire,firePreview);
photoBefore.onchange=()=>preview(photoBefore,beforePreview);
photoAfter.onchange=()=>preview(photoAfter,afterPreview);

async function exportPDF(){
  const pdf=new jspdf.jsPDF("p","mm","a4");
  const canvas=await html2canvas(document.body);
  pdf.addImage(canvas.toDataURL("image/png"),"PNG",5,5,200,0);
  pdf.save("Hot_Work_Permit.pdf");
}

date.value=new Date().toISOString().split("T")[0];
</script>

<script>
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hot Works Permit</title>

<link rel="manifest" href="manifest.json">

<style>
body{
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background:#f4f4f4;
  margin:0;
  padding:10px;
}
h2{margin-top:20px}
.section{
  background:#fff;
  padding:15px;
  margin-bottom:15px;
  border-radius:10px;
}
label{display:block;margin-top:10px;font-weight:600}
input, textarea, select{
  width:100%;
  padding:10px;
  margin-top:5px;
  font-size:16px;
}
textarea{min-height:120px}
canvas{
  border:1px solid #ccc;
  width:100%;
  height:160px;
  touch-action:none;
}
.locked{
  pointer-events:none;
  opacity:0.6;
}
button{
  margin-top:10px;
  padding:12px;
  font-size:16px;
  width:100%;
}
.photo-preview img{
  max-width:100%;
  margin-top:10px;
  border-radius:8px;
}
</style>
</head>

<body>

<h1>Hot Works Permit</h1>

<div class="section">
<label>Date</label>
<input type="date" id="date">

<label>Site / Location</label>
<input type="text" id="site">

<label>Company / Contractor</label>
<input type="text" id="company">
</div>

<div class="section">
<h2>Type of Hot Work</h2>

<label>
<select id="hotType">
  <option value="">Select</option>
  <option>Welding</option>
  <option>Cutting</option>
  <option>Grinding</option>
  <option>Oxy / LPG Heating</option>
  <option>Brazing / Soldering</option>
  <option>Torch-on / Heat Gun</option>
  <option>Other</option>
</select>
</label>

<label>If Other, describe</label>
<textarea id="hotOther"></textarea>
</div>

<div class="section">
<h2>Work Description</h2>
<textarea id="description" placeholder="Detailed description of works"></textarea>
</div>

<div class="section">
<h2>PPE Required</h2>
<textarea id="ppe" placeholder="e.g. Welding helmet, gloves, FR clothing, eye protection"></textarea>
</div>

<div class="section">
<h2>Fire Watch</h2>

<label>Fire Watcher Name</label>
<input type="text" id="fireName">

<label>Fire watch must remain for 30 minutes post works.</label>

<label>Fire Watch Signature</label>
<canvas id="fireSig"></canvas>
<button onclick="clearSig('fireSig')">Undo Signature</button>

<label>Time Signed</label>
<input type="time" id="fireTime">
</div>

<div class="section">
<h2>Permit Authorisation</h2>

<label>Authorised By</label>
<input type="text" id="authName">

<label>Authorising Signature</label>
<canvas id="authSig"></canvas>
<button onclick="clearSig('authSig')">Undo Signature</button>

<label>Time Signed</label>
<input type="time" id="authTime">
</div>

<div class="section">
<h2>Photos</h2>

<label>Before Work</label>
<input type="file" accept="image/*" capture="environment" id="photoBefore">
<div class="photo-preview" id="beforePreview"></div>

<label>After Work</label>
<input type="file" accept="image/*" capture="environment" id="photoAfter">
<div class="photo-preview" id="afterPreview"></div>
</div>

<div class="section">
<button onclick="exportPDF()">Export Permit (PDF)</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let permitFinalised = false;

const fields = document.querySelectorAll("input,textarea,select");

fields.forEach(f=>{
  f.oninput = saveData;
});

function saveData(){
  const data = {};
  fields.forEach(f=>data[f.id]=f.value);
  localStorage.setItem("permitData", JSON.stringify(data));
}

(function loadData(){
  const d = JSON.parse(localStorage.getItem("permitData")||"{}");
  fields.forEach(f=>{ if(d[f.id]) f.value=d[f.id]; });
})();

// SIGNATURE HANDLING
function setupCanvas(id){
  const c = document.getElementById(id);
  const ctx = c.getContext("2d");
  let drawing=false;

  c.addEventListener("touchstart",e=>{
    if(permitFinalised) return;
    drawing=true;
    ctx.beginPath();
    ctx.moveTo(e.touches[0].clientX-c.offsetLeft, e.touches[0].clientY-c.offsetTop);
  });

  c.addEventListener("touchmove",e=>{
    if(!drawing||permitFinalised) return;
    ctx.lineTo(e.touches[0].clientX-c.offsetLeft, e.touches[0].clientY-c.offsetTop);
    ctx.stroke();
  });

  c.addEventListener("touchend",()=>drawing=false);
}

setupCanvas("fireSig");
setupCanvas("authSig");

function clearSig(id){
  if(permitFinalised) return;
  const c=document.getElementById(id);
  c.getContext("2d").clearRect(0,0,c.width,c.height);
}

// LOCK AFTER FINAL SIGNATURES
document.getElementById("fireTime").onchange = lockCheck;
document.getElementById("authTime").onchange = lockCheck;

function lockCheck(){
  if(fireTime.value && authTime.value){
    permitFinalised = true;
    fields.forEach(f=>f.disabled=true);
    document.querySelectorAll("canvas").forEach(c=>c.classList.add("locked"));
  }
}

// PHOTO PREVIEW
photoBefore.onchange = ()=>preview(photoBefore, beforePreview);
photoAfter.onchange = ()=>preview(photoAfter, afterPreview);

function preview(input, box){
  const img=document.createElement("img");
  img.src=URL.createObjectURL(input.files[0]);
  box.innerHTML="";
  box.appendChild(img);
}

// EXPORT
async function exportPDF(){
  const pdf = new jspdf.jsPDF("p","mm","a4");
  const canvas = await html2canvas(document.body);
  const imgData = canvas.toDataURL("image/png");
  pdf.addImage(imgData,"PNG",5,5,200,0);
  pdf.save("Hot_Work_Permit.pdf");
}
</script>

</body>
</html>